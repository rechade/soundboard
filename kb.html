<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>MC Ricky G KB</title>
  <meta name="description" content="MC Ricky G KB">
  <meta name="MC Ricky G" content="KB">
  <link rel="stylesheet" href="css/styles.css?v=1.0">
<style type="text/css">
	* {padding:0; margin:0;}
  	html {
    	-webkit-user-select: none;
    	-webkit-touch-callout: none;
		width: 100%;
		height: 100%;
	}
	body {
		width: 100%;
		height: 100%;
	}
	table {
    	width:100%;
		height:100%;
	}
</style>
  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>
<body onresize="pads.resizePads()">	
	<table border = "1">
         <tr>
            <td>
				Root Note:
				<form name="rootNoteForm">
					<input type="radio" name="rootNoteRadios" value=0 id='0'/>C<br>
					<input type="radio" name="rootNoteRadios" value=1 id='1'/>C#<br>
					<input type="radio" name="rootNoteRadios" value=2 id='2'/>D<br>
					<input type="radio" name="rootNoteRadios" value=3 id='3'/>D#<br>
					<input type="radio" name="rootNoteRadios" value=4 id='4'/>E<br>
					<input type="radio" name="rootNoteRadios" value=5 id='5'/>F<br>
					<input type="radio" name="rootNoteRadios" value=6 id='6'/>F#<br>
					<input type="radio" name="rootNoteRadios" value=7 id='7'/>G<br>
					<input type="radio" name="rootNoteRadios" value=8 id='8'/>G#<br>
					<input type="radio" name="rootNoteRadios" value=9 id='9'/>A<br>
					<input type="radio" name="rootNoteRadios" value=10 id='10'/>A#<br>
					<input type="radio" name="rootNoteRadios" value=11 id='11'/>B<br>
				</form>
				<br/>
				<br/>
				Layout:
				<form name="layoutForm">
					<input type="radio" name="layoutRadios" value=0 id='UP_IN_FOURTHS'/>^4s<br>
					<input type="radio" name="layoutRadios" value=1 id='UP_IN_THIRDS'/>^3s<br>
					<input type="radio" name="layoutRadios" value=2 id='SEQUENTIAL'/>Seq<br>
				</form>
				<br/>
				<br/>Octave:
				<div class="button_group">
					<button onclick="add()" id="add">+ 1</button>
					<div id="octave">0</div>					
					<button onclick="subtract()" id="subtract">- 1</button>
				</div>
				<br/>
				<br/>In Key:
				<div class="button_group">
					<input type="checkbox" id="inKeyCheckbox" onclick="changeInKey()">
				</div>
			</td>
            <td width="100%" ><div id='padsCell' style="height:100%">
				<canvas id="myCanvas" onmousedown="handleTouchStart(event.clientX,event.clientY,event.button)" onmouseup="handleTouchEnd(event.button)" style="border:1px solid #d3d3d3;">
					Your browser does not support the HTML5 canvas tag.
				</canvas>
				</div>
			</td>
            <td>				
				<!--textarea id="mytextarea" rows="1"></textarea>
				<textarea id="mytouchtext" rows="1"></textarea>
				<textarea id="mynumtouchestext" rows="1"></textarea-->				
				Scale:
				<form name="scaleForm">
					<input type="radio" name="scaleRadios" value=0 id='MAJ'/>MAJ<br>
					<input type="radio" name="scaleRadios" value=1 id='MIN'/>MIN<br>
					<input type="radio" name="scaleRadios" value=2 id='DOR'/>DOR<br>
					<input type="radio" name="scaleRadios" value=3 id='MIX'/>MIX<br>
					<input type="radio" name="scaleRadios" value=4 id='LYD'/>LYD<br>
					<input type="radio" name="scaleRadios" value=5 id='PHR'/>PHR<br>
					<input type="radio" name="scaleRadios" value=6 id='LOC'/>LOC<br>
					<input type="radio" name="scaleRadios" value=7 id='DIM'/>DIM<br>
					<input type="radio" name="scaleRadios" value=8 id='WHOLE_HALF'/>WH-H<br>
					<input type="radio" name="scaleRadios" value=9 id='WHOLE'/>WH<br>
					<input type="radio" name="scaleRadios" value=10 id='MINOR_BLUES'/>MIN BL<br>
					<input type="radio" name="scaleRadios" value=11 id='MINOR_PENT'/>MIN PENT<br>
					<input type="radio" name="scaleRadios" value=12 id='MAJOR_PENT'/>MAJ PENT<br>
					<input type="radio" name="scaleRadios" value=13 id='HARMONIC_MIN'/>HARM MIN<br>
					<input type="radio" name="scaleRadios" value=14 id='MELODIC_MIN'/>MEL MIN<br>
					<input type="radio" name="scaleRadios" value=15 id='SUPER_LOC'/>SUP-LOC<br>
					<input type="radio" name="scaleRadios" value=16 id='FOURTHS'/>FOURTHS<br>
					<input type="radio" name="scaleRadios" value=17 id='THIRDS'/>THIRDS<br>
				</form>				
			</td>
        </tr>
    </table>	
	<script src="scripts/pads.js"></script>  
	<script src="scripts/scales.js"></script>
	<script>
		var canvas=document.getElementById("myCanvas");
		var ctx=canvas.getContext("2d"); 		
		var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
		var rootNoteRadios = document.rootNoteForm.rootNoteRadios;
		var MAX_TOUCHES = 5;
		var touches = [];
		var oscillators = [];
		var gainNodes = [];
		var touchedPads = [];

		for(var i = 0; i < rootNoteRadios.length; i++) {
			rootNoteRadios[i].onclick = function() {		
				scales.changeRootNote(this.value);
				scales.allocatePadNotes();								
			};
		};

		var layoutRadios = document.layoutForm.layoutRadios;				
		for(var i = 0; i < layoutRadios.length; i++) {
			layoutRadios[i].onclick = function() {				
				scales.changeLayout(this.value);				
			};
		};

		var scaleRadios = document.scaleForm.scaleRadios;		
		for(var i = 0; i < scaleRadios.length; i++) {
			scaleRadios[i].onclick = function() {				
				scales.changeScale(this.value);		
        		scales.allocatePadNotes();
				pads.reRender();				
			};
		};
		myInit();

		function myInit() {			
			var osc=null;
			var gainNode=null;
			for (var i=0; i<MAX_TOUCHES; i++){
				osc = audioCtx.createOscillator();
				gainNode = audioCtx.createGain();	
				gainNode.connect(audioCtx.destination);
				gainNode.gain.value = 0.0;
				osc.type = 'sine';
				osc.connect(gainNode);
				osc.start();
				oscillators[i]=osc;
				gainNodes[i]=gainNode;
				touchedPads[i]=-99;
			}			
			preventLongPressMenu(document.getElementById('myCanvas'));		
			document.getElementById("octave").innerHTML = scales.octave;
			scales.changeRootNote(scales.rootNote);			
			scales.changeScale(scales.scaleType);	
        	scales.allocatePadNotes();
			pads.reRender();					
			layoutRadio = document.getElementById(stringOfEnum(LayoutType,scales.layoutType));
			layoutRadio.checked = true;
			scaleRadio = document.getElementById(stringOfEnum(ScaleType,scales.scaleType));
			scaleRadio.checked = true;
			scalesRadio = document.getElementById(scales.rootNote);
			scalesRadio.checked = true;
			inKeyCheckbox = document.getElementById('inKeyCheckbox');
			inKeyCheckbox.checked = scales.inKey;			
			pads.resizePads();			
			// prevent scrolling
			document.body.addEventListener('touchmove', function(event) {			
				event.preventDefault();
				event.stopPropagation();
				event.preventDefault();
				/*
				setTimeout(
					function(){
						osc.stop();
					}, 500
				);
				*/
			}, false);
			canvas.addEventListener('touchmove', function(event) {
				for (var i = 0; i < event.changedTouches.length; i++) {
					var touchId = event.touches[i].identifier;
					var x = event.changedTouches[touchId].pageX;
					var y = event.changedTouches[touchId].pageY;									
					var padNum = calcPadNum(x,y);
					if (touchedPads[touchId]!=padNum){
						playNote(padNum, oscillators[touchId],gainNodes[touchId]);
					}					
					event.preventDefault();
					event.stopPropagation();
					touchedPads[touchId]=padNum;					
				} 
				//event.preventDefault();
				/*
				setTimeout(
					function(){
						osc.stop();
					}, 500
				);
				*/
			}, false);
			// handle initial touches
			canvas.addEventListener('touchstart', function(event) {				
				for (var i = 0; i < event.touches.length; i++) {
					var touchId = event.touches[i].identifier;
					if (!touches[touchId]){
						var pageX = event.touches[touchId].pageX;
						var pageY = event.touches[touchId].pageY;									
						touches[touchId] = true;
						event.preventDefault();
						event.stopPropagation();
						touchedPads[touchId]=handleTouchStart(pageX,pageY,touchId);						
					}
				}
				//document.getElementById("mytextarea").innerHTML = touchedPads;
			}, false);

			canvas.addEventListener("touchend",function(event){
				for(var i = 0; i<event.changedTouches.length; i++){										
					handleTouchEnd(event.changedTouches[i].identifier);					
				}
			}, false);
		};
		var numTouches=0;
		function handleTouchStart(touchX,touchY,touchId){
			var padNum;
			if (numTouches < MAX_TOUCHES) {				
				padNum = calcPadNum(touchX,touchY);				
				playNote(padNum,oscillators[touchId],gainNodes[touchId]);
				numTouches++;				
			}
			return padNum;
		};
		function handleTouchEnd(touchId){
			if (numTouches > 0){				
				stopNote(oscillators[touchId],gainNodes[touchId]);
				numTouches--;
				touches[touchId]=false;
				touchedPads[touchId]=-99;
				//document.getElementById("mytextarea").innerHTML = touchedPads;
			}
		};
		function playNote(padNum,osc,gainNode){			
			var now = audioCtx.currentTime;
			gainNode.gain.cancelScheduledValues( now );
			
			// Anchor beginning of ramp at current value.
			gainNode.gain.setValueAtTime(gainNode.gain.value, now);
			var pow = (scales.notes[padNum] - 69) / 12.0;
			var frequency = 440 * Math.pow(2, pow);
			osc.frequency.value = frequency;								
			//osc.connect(gainNode);
			 // Ramp quickly up.
			gainNode.gain.linearRampToValueAtTime(1.0, now + 0.1);
			// Then decay down to a sustain level.
			gainNode.gain.exponentialRampToValueAtTime(0.2, now + 0.3);
		};
		function stopNote(osc,gainNode){
			var now = audioCtx.currentTime;	
			gainNode.gain.cancelScheduledValues( now );
			// Anchor beginning of ramp at current value.
			gainNode.gain.setValueAtTime(gainNode.gain.value, now);
			// Ramp down.
        	gainNode.gain.linearRampToValueAtTime(0.0, now + 0.5);		
			//osc.disconnect();
		};
		function calcPadNum(x,y){
			x = x - pads.padsX;
			y = y - pads.padsY;
			var colNum = Math.floor(x / pads.padWidth);
			var rowNum = pads.NUM_ROWS - Math.floor(y / pads.padHeight)-1;
			return colNum + (rowNum * pads.NUM_COLS);
		};
		function stringOfEnum(e,value) {
  			for (var k in e) if (e[k] == value) return k;
			return null;
		};
		function changeInKey(){
			scales.inKey = !scales.inKey;
        	scales.allocatePadNotes();
			pads.reRender();
		};
		function subtract(){
			if (scales.octave >1){
				scales.octave = scales.octave-1;
				document.getElementById("octave").innerHTML = scales.octave;
				scales.allocatePadNotes();				
			}
		};
		function add(){
			if (scales.octave < 8){
				scales.octave = scales.octave+1;
				document.getElementById("octave").innerHTML = scales.octave;
				scales.allocatePadNotes();
			}
		};
		function absorbEvent_(event) {
			var e = event || window.event;
			e.preventDefault && e.preventDefault();
			e.stopPropagation && e.stopPropagation();
			e.cancelBubble = true;
			e.returnValue = false;
			return false;
		};
		function preventLongPressMenu(node) {
			node.ontouchstart = absorbEvent_;
			node.ontouchmove = absorbEvent_;
			node.ontouchend = absorbEvent_;
			node.ontouchcancel = absorbEvent_;
		};
  </script>
</body>
</html>